<?xml version="1.0" encoding="UTF-8"?>

<project name="ApplicationExec" default="usage" basedir=".">
    <description>
        This project is a set of helper targets for the TongueTied project. The
        primary use of these targets is for use in an automated build 
        environment. Developers though, can use these targets as needed.
    </description>

    <property name="app.root" value="${basedir}/../"/>
    
    <property file="${app.root}/BuildInfra/global.properties"/>  

    <property name="db.url" value="jdbc:hsqldb:hsql://localhost"/>
    <property name="db.name" value="tonguetied"/>
    <property name="db.port" value="9010"/>
    <property name="db.user" value="sa"/>
    <property name="db.pw" value=""/>
    <property name="db.path" value="${app.root}/data/${db.name}"/>

    <!-- temporary directories and files -->
    <property name="classes.dir" value="classes"/>
    <property name="generated.dir" value="generated"/>
    <property name="fmpp.log.file" value="${generated.dir}/fmpp.log"/>
    
    <path id="db.server.classpath">
        <pathelement location="${3rdparty.home}/HSQLDB/1.8.0.9/hsqldb.jar"/>
    </path>

    <path id="fmpp.classpath">
        <pathelement location="${3rdparty.home}/FreeMarker/FMPP/0.9.13/fmpp.jar"/>
        <pathelement location="${3rdparty.home}/FreeMarker/2.3.13/freemarker.jar"/>
        <pathelement location="${3rdparty.home}/bsh/2.0b4/bsh.jar"/>
        <pathelement location="${3rdparty.home}/oro/2.0.8/jakarta-oro-2.0.8.jar"/>
        <path refid="db.server.classpath"/>
    </path>
    
    <path id="tonguetied.server.classpath">
        <pathelement location="${server.home}/builds/jettyServer.jar"/>
        <pathelement location="${3rdparty.home}/Jetty/6.1.9/jetty.jar"/>
        <pathelement location="${3rdparty.home}/Log4j/1.2.15/log4j.jar"/>
        <pathelement location="${3rdparty.home}/Jetty/5.1.5/javax.servlet.jar"/>
        <pathelement location="${3rdparty.home}/Ant/1.7.0/ant.jar"/>
        <pathelement location="${server.home}/builds/server.jar"/>
        <pathelement location="${3rdparty.home}/Spring/2.5.4/spring.jar"/>
        <pathelement location="${3rdparty.home}/Jakarta-Commons/commons-logging.jar"/>
        <pathelement location="${3rdparty.home}/Quartz/1.5.2/quartz.jar"/>
        <pathelement location="${3rdparty.home}/Hibernate/3.2.6/hibernate3.jar"/>
    </path>
    
    <taskdef name="fmpp" 
             classname="fmpp.tools.AntTask" 
             classpathref="fmpp.classpath"/>
    
    <target name="init">
        <mkdir dir="${classes.dir}"/>
        <mkdir dir="${generated.dir}"/>
    </target>

    <target name="usage">
        <echo message="Use ant -p for target description"></echo>
    </target>
    
    <target name="start.hsql.db" description="Start the HyperSonic Database server">
        <echo message="Starting HyperSonic Database server..."/>
        <java classname="org.hsqldb.Server" fork="true">
            <classpath refid="db.server.classpath"/>
            <!--arg value="-?"/-->
            <arg value="-database"/>
            <arg value="${db.path}"/>
            <arg value="-dbname"/>
            <arg value="${db.name}"/>
            <arg value="-port"/>
            <arg value="${db.port}"/>
        </java>
    </target>

    <target name="stop.hsql.db" description="Shutdown the HyperSonic Database server">
        <echo message="Stopping HyperSonic Database server..."/>
        <sql driver="${tonguetied.db.driver}"
             url="${db.url}:${db.port}/${db.name}"
             classpathref="db.server.classpath"
             autocommit="true"
             password="${db.pw}"
             userid="${db.user}">
            <transaction>shutdown;</transaction>
        </sql>
    </target>
    
    <target name="start.server" description="Start the TongueTied server with Jetty">
        <echo message="Starting TongueTied server..."/>
        <java classname="org.tonguetied.server.Server" fork="false">
            <classpath refid="tonguetied.server.classpath"/>
            <classpath refid="temporary.server.path"/>
            <arg value="-w"/>
            <arg value="${server.home}/builds/tonguetied.war"/>
            <arg value="-keystore"/>
            <arg value="${server.home}/generated/keystore"/>
        </java>
    </target>
    
    <target name="stop.server" description="Stop the TongueTied server">
        <echo message="Stopping TongueTied server..."/>
        <java classname="org.tonguetied.server.Server" fork="false">
            <classpath refid="tonguetied.server.classpath"/>
            <arg value="-shutdown"/>
        </java>
    </target>
    
    <target name="export" depends="init" description="Generate csv, xls, xml files from the descriptions in the Multi Language Portal">
        <echo message="Generating export files for project ${ant.project.name} ..."/>
        <input message="Enter the 2 letter ISO language code, for the new language you want translated. Valid values are: "
               validargs="DE,ZH,TA,HI,JP,KR"
               addproperty="language.code"/>
        <fmpp sourceroot="${templates.dir}/freemarker/export" 
              outputroot="${generated.dir}" 
              logfile="${fmpp.log.file}" 
              outputencoding="UTF-8">
            <include name="**/*.ftl"/>
            <data expandproperties="true">
                rows: sql({url: ${tonguetied.db.url}:${tonguetied.db.port},driver:${tonguetied.db.driver},username:${tonguetied.db.username}},'select KEYWORDS, BUNDLE, CONTEXT, EN, ${language.code} from language_keys')
            </data>
        </fmpp>
    </target>
</project>
